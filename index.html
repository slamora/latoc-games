<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Simón Circular - Tactical Edition</title>
  <style>
    body {
      margin: 0;
      background-color: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>

<body>
  <script>
    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 800,
      backgroundColor: '#333333',
      physics: { default: 'arcade', arcade: { debug: false } },
      scene: { preload: preload, create: create, update: update }
    };

    let game = new Phaser.Game(config);
    let arenaCenter = { x: 400, y: 400 }, arenaRadius = 200, isGameOver = false;

    // Datos de los jugadores con las nuevas posiciones (270º arriba, 90º abajo)
    let p1Data = {
      name: "J1", color: 0x00ffff,
      angle: Math.PI * 1, // (180 Left)
      angVel: 0, angAccel: 0.0006, friction: 0.96, maxSpeed: 0.05,
      health: 3, maxHealth: 3,
      aimAngle: Math.PI * 0, // Apuntando hacia el centro
      laserGfx: null
    };

    let p2Data = {
      name: "J2", color: 0xff00ff,
      angle: Math.PI * 0, // 0 grados (Right)
      angVel: 0, angAccel: 0.0006, friction: 0.96, maxSpeed: 0.05,
      health: 3, maxHealth: 3,
      aimAngle: Math.PI * 1, // Apuntando hacia el centro
      laserGfx: null
    };

    function preload() {
      let g = this.make.graphics();
      const drawTankIcon = (graphics, color) => {
        graphics.clear();
        graphics.fillStyle(color);
        graphics.fillRect(5, 10, 20, 20);
        graphics.fillRect(12, 0, 6, 12);
      };
      drawTankIcon(g, p1Data.color);
      g.generateTexture('p1', 30, 30);
      drawTankIcon(g, p2Data.color);
      g.generateTexture('p2', 30, 30);
      g.clear().fillStyle(0xffffff).fillCircle(5, 5, 5).generateTexture('ball', 10, 10);
      g.destroy();
    }

    function create() {
      // Escenario
      this.add.graphics().lineStyle(4, 0x555555).strokeCircle(arenaCenter.x, arenaCenter.y, arenaRadius);

      // Sprites y Láseres
      p1Data.sprite = this.physics.add.sprite(0, 0, 'p1');
      p2Data.sprite = this.physics.add.sprite(0, 0, 'p2');
      p1Data.laserGfx = this.add.graphics();
      p2Data.laserGfx = this.add.graphics();

      p1Data.bullets = this.physics.add.group({ maxSize: 2 });
      p2Data.bullets = this.physics.add.group({ maxSize: 2 });

      // UI
      p1Data.healthBar = createHealthBar(this, 50, 50, p1Data.color);
      p2Data.healthBar = createHealthBar(this, 550, 50, p2Data.color);

      this.add.text(50, 15, "P1: A-D (Mover) | W-S (Apuntar) | ESPACIO (Disparar)", { fontSize: '11px', fill: '#00ffff' });
      this.add.text(480, 15, "P2: ←→ (Mover) | ↑↓ (Apuntar) | ENTER (Disparar)", { fontSize: '11px', fill: '#ff00ff' });

      // Controles
      p1Data.keys = this.input.keyboard.addKeys({ left: 'A', right: 'D', up: 'W', down: 'S', fire: 'SPACE' });
      p2Data.keys = this.input.keyboard.addKeys({ left: 'LEFT', right: 'RIGHT', up: 'UP', down: 'DOWN', fire: 'ENTER' });

      this.input.keyboard.on('keydown-SPACE', () => { if (!isGameOver) fire(this, p1Data); });
      this.input.keyboard.on('keydown-ENTER', () => { if (!isGameOver) fire(this, p2Data); });

      this.physics.add.overlap(p2Data.sprite, p1Data.bullets, (p, b) => hit(this, p2Data, b));
      this.physics.add.overlap(p1Data.sprite, p2Data.bullets, (p, b) => hit(this, p1Data, b));
    }

    function update() {
      if (isGameOver) return;
      updatePlayer(p1Data);
      updatePlayer(p2Data);

      [p1Data.bullets, p2Data.bullets].forEach(g => {
        g.children.iterate(b => {
          if (b && b.active && Phaser.Math.Distance.Between(arenaCenter.x, arenaCenter.y, b.x, b.y) > arenaRadius + 150) {
            b.setActive(false).setVisible(false);
          }
        });
      });
    }

    function updatePlayer(d) {
      // 1. Movimiento
      if (d.keys.left.isDown) d.angVel -= d.angAccel;
      else if (d.keys.right.isDown) d.angVel += d.angAccel;
      d.angVel *= d.friction;
      d.angVel = Phaser.Math.Clamp(d.angVel, -d.maxSpeed, d.maxSpeed);
      d.angle += d.angVel;
      d.sprite.setPosition(arenaCenter.x + arenaRadius * Math.cos(d.angle), arenaCenter.y + arenaRadius * Math.sin(d.angle));

      // 2. Apuntado
      if (d.keys.up.isDown) d.aimAngle -= 0.04;
      if (d.keys.down.isDown) d.aimAngle += 0.04;
      d.sprite.setRotation(d.aimAngle + Math.PI / 2);

      // 3. Dibujar Láser CORTO (1/5 del radio)
      d.laserGfx.clear();
      d.laserGfx.lineStyle(1, d.color, 0.4);
      let laserLength = arenaRadius / 5; // Modificado a 1/5 del radio
      let lx = d.sprite.x + Math.cos(d.aimAngle) * laserLength;
      let ly = d.sprite.y + Math.sin(d.aimAngle) * laserLength;
      d.laserGfx.lineBetween(d.sprite.x, d.sprite.y, lx, ly);
    }

    function fire(scene, d) {
      let b = d.bullets.get();
      if (b) {
        b.setActive(true).setVisible(true).setTexture('ball').setPosition(d.sprite.x, d.sprite.y);
        scene.physics.velocityFromRotation(d.aimAngle, 500, b.body.velocity);
      }
    }

    function createHealthBar(scene, x, y, color) {
      scene.add.graphics().fillStyle(0x555555).fillRect(x, y, 200, 20);
      let barGraphics = scene.add.graphics();
      let barObj = { bar: barGraphics, x: x, y: y, color: color };
      updateHealthBarVisual(barObj, 1);
      return barObj;
    }

    function updateHealthBarVisual(barObj, pct) {
      barObj.bar.clear().fillStyle(barObj.color).fillRect(barObj.x, barObj.y, 200 * Math.max(0, pct), 20);
    }

    function hit(scene, p, b) {
      if (!b.active) return;
      b.setActive(false).setVisible(false).body.stop();
      p.health--;
      updateHealthBarVisual(p.healthBar, p.health / p.maxHealth);
      scene.tweens.add({ targets: p.sprite, alpha: 0, duration: 50, yoyo: true, repeat: 3 });
      if (p.health <= 0) {
        isGameOver = true;
        scene.add.text(400, 400, `¡GANA EL ${p.name === 'J1' ? 'JUGADOR 2' : 'JUGADOR 1'}!`, { fontSize: '40px', color: '#fff', backgroundColor: '#000' }).setOrigin(0.5);
      }
    }
  </script>
</body>

</html>
